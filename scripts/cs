#!/usr/bin/env bash
# cs - Claude Code Session Conductor
#
# Single entry point for managing Claude Code sessions.
# Everything lives inside one tmux session as windows.
# When Claude exits, you return to the picker.
#
# Usage:
#   cs              â†’ enter conductor (outside tmux) or open picker (inside)
#   cs new [name]   â†’ create new worktree session directly
#   cs _list        â†’ (internal) output worktree list for fzf reload
#   cs _open <win>  â†’ (internal) open or restart a session
#   cs _remove <win>â†’ (internal) remove a worktree

set -euo pipefail

WORKSPACE="${WORKSPACE:-$HOME/Workspace}"
SESSION="conductor"
SELF="$(realpath "$0")"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_git_info() {
  local dir="$1"
  local branch
  branch=$(git -C "$dir" branch --show-current 2>/dev/null || echo "-")
  if [[ -n "$(git -C "$dir" status --porcelain 2>/dev/null)" ]]; then
    branch+="*"
  fi
  echo "$branch"
}

# â”€â”€ List all worktrees (active + inactive) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_list_all() {
  local active_wins
  active_wins=$(tmux list-windows -t "$SESSION" -F '#{window_name}|#{pane_pid}' 2>/dev/null || echo "")

  for project_dir in "$WORKSPACE"/*/; do
    [[ ! -d "$project_dir/.claude/worktrees" ]] && continue
    local project
    project=$(basename "$project_dir")

    for wt_dir in "$project_dir/.claude/worktrees"/*/; do
      [[ ! -d "$wt_dir" ]] && continue
      local wt_name
      wt_name=$(basename "$wt_dir")
      local win_name="${project}/${wt_name}"

      local active="â—‹"
      local pid
      pid=$(echo "$active_wins" | awk -F'|' -v w="$win_name" '$1==w {print $2}')
      if [[ -n "$pid" ]] && pgrep -P "$pid" -f "claude" >/dev/null 2>&1; then
        active="â—"
      fi

      local git_info
      git_info=$(_git_info "$wt_dir")
      printf "%s  %-30s  ðŸŒ¿ %s\n" "$active" "$win_name" "$git_info"
    done
  done
}

# â”€â”€ Open or restart a session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_open_session() {
  local win_name="${1:-}"
  [[ -z "$win_name" ]] && return 1

  local project="${win_name%%/*}"
  local wt_name="${win_name#*/}"
  local project_dir="$WORKSPACE/$project"

  # If window already exists, switch to it
  if tmux list-windows -t "$SESSION" -F '#{window_name}' 2>/dev/null | grep -qxF "$win_name"; then
    tmux select-window -t "${SESSION}:${win_name}"
    return
  fi

  # Restart Claude in project root, pointing to existing worktree
  tmux new-window -t "$SESSION" -n "$win_name" -c "$project_dir" \
    "claude --dangerously-skip-permissions --worktree ${wt_name}; tmux select-window -t ${SESSION}:hub"
}

# â”€â”€ Remove a worktree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_remove_worktree() {
  local win_name="${1:-}"
  [[ -z "$win_name" ]] && return 1

  local project="${win_name%%/*}"
  local wt_name="${win_name#*/}"
  local project_dir="$WORKSPACE/$project"

  # Kill tmux window if active
  if tmux list-windows -t "$SESSION" -F '#{window_name}' 2>/dev/null | grep -qxF "$win_name"; then
    tmux kill-window -t "${SESSION}:${win_name}"
  fi

  # Remove git worktree (fallback to rm if not a proper worktree)
  git -C "$project_dir" worktree remove ".claude/worktrees/$wt_name" --force 2>/dev/null \
    || rm -rf "$project_dir/.claude/worktrees/$wt_name"
}

# â”€â”€ Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_picker() {
  local worktrees
  worktrees=$(_list_all)

  if [[ -z "$worktrees" ]]; then
    return 1  # no worktrees
  fi

  local selected
  selected=$(echo "$worktrees" | fzf \
    --prompt="Claude > " \
    --header="Enter=open/restart  d=delete  n=new  ctrl-r=refresh  Esc=quit" \
    --reverse --border \
    --bind="ctrl-r:reload($SELF _list)" \
    --bind="d:execute-silent($SELF _remove {2})+reload($SELF _list)" \
    --bind="n:abort" \
    --expect="n" \
    --ansi) || return $?

  local key
  key=$(echo "$selected" | sed -n '1p')
  local line
  line=$(echo "$selected" | sed -n '2p')

  if [[ "$key" == "n" ]]; then
    return 1  # signal: create new
  fi

  local win_name
  win_name=$(echo "$line" | awk '{print $2}')
  if [[ -n "$win_name" ]]; then
    _open_session "$win_name"
  fi
}

# â”€â”€ Hub loop (runs inside hub window) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_hub() {
  while true; do
    clear
    if _picker; then
      :  # switched/opened session, loop resumes when we return
    else
      local exit_code=$?
      if [[ $exit_code -eq 1 ]]; then
        # No worktrees or user pressed 'n' â†’ create new
        _create_session ""
      elif [[ $exit_code -eq 130 ]]; then
        # ESC or Ctrl-C â†’ confirm quit
        printf "Quit conductor? [y/N] "
        read -r ans
        if [[ "$ans" =~ ^[Yy]$ ]]; then
          tmux kill-session -t "$SESSION" 2>/dev/null
          exit 0
        fi
      fi
    fi
    sleep 0.1
  done
}

# â”€â”€ Create session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_create_session() {
  local wt_name="${1:-}"

  local projects
  projects=$(find "$WORKSPACE" -maxdepth 1 -mindepth 1 -type d \
    ! -name '*__worktrees' ! -name '.*' ! -name 'scripts' \
    -exec basename {} \; | sort)

  local project
  project=$(echo "$projects" | fzf \
    --prompt="Project > " \
    --header="Select project for new Claude session" \
    --preview="git -C '$WORKSPACE'/{} log --oneline -5 2>/dev/null || ls '$WORKSPACE'/{}" \
    --reverse --border) || return 0

  local project_dir="$WORKSPACE/$project"

  if ! git -C "$project_dir" rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: $project is not a git repository"
    sleep 2
    return 1
  fi

  if [[ -z "$wt_name" ]]; then
    printf "Worktree name (empty=auto): "
    read -r wt_name
  fi

  local win_name="$project"
  if [[ -n "$wt_name" ]]; then
    win_name="${project}/${wt_name}"
  fi

  local claude_cmd="claude --dangerously-skip-permissions --worktree"
  if [[ -n "$wt_name" ]]; then
    claude_cmd+=" ${wt_name}"
  fi

  tmux new-window -t "$SESSION" -n "$win_name" -c "$project_dir" \
    "$claude_cmd; tmux select-window -t ${SESSION}:hub"
}

# â”€â”€ Entry point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_enter() {
  if [[ -n "${TMUX:-}" ]]; then
    local current_session
    current_session=$(tmux display-message -p '#S')
    if [[ "$current_session" == "$SESSION" ]]; then
      if [[ "${1:-}" == "new" ]]; then
        _create_session "${2:-}"
      else
        _picker
      fi
    else
      tmux switch-client -t "$SESSION" 2>/dev/null || {
        echo "Conductor not running. Start cs from outside tmux first."
        return 1
      }
    fi
    return
  fi

  # Outside tmux: create or attach
  if tmux has-session -t "$SESSION" 2>/dev/null; then
    tmux attach-session -t "$SESSION"
    return
  fi

  # Create conductor session, hub runs the loop directly
  tmux new-session -d -s "$SESSION" -n "hub" -c "$HOME"
  tmux send-keys -t "${SESSION}:hub" "$SELF _hub" Enter
  tmux attach-session -t "$SESSION"
}

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

case "${1:-}" in
  new)
    if [[ -n "${TMUX:-}" ]]; then
      _create_session "${2:-}"
    else
      echo "Run 'cs' first to enter the conductor."
      exit 1
    fi
    ;;
  _hub)    _hub ;;
  _list)   _list_all ;;
  _open)   _open_session "${2:-}" ;;
  _remove) _remove_worktree "${2:-}" ;;
  help|-h|--help)
    cat <<'EOF'
cs - Claude Code Session Conductor

Start:
  cs                    Enter the conductor (or show picker if inside)

Inside picker:
  Enter                 Open or restart selected session
  d                     Delete worktree
  n                     Create new worktree session
  Ctrl-R                Refresh session list
  Esc                   Stay in hub

From any window:
  Ctrl+/ f              Picker popup
  Ctrl+/ N              New session popup
  Ctrl+/ 0              Return to hub

When Claude exits, you return to the picker automatically.
EOF
    ;;
  *)
    _enter "$@"
    ;;
esac
